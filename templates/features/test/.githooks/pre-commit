#!/bin/bash

# Pre-commit hook for Lamdera projects with lamdera-program-test

echo "ğŸ” Running pre-commit checks..."

# 1. Run elm-format
echo "ğŸ¨ Running elm-format..."
if ! elm-format --yes src/ tests/; then
    echo "âŒ elm-format failed! Please install elm-format:"
    echo "   npm install -g elm-format"
    exit 1
fi

echo "âœ… elm-format completed!"

# 2. Check compilation (including tests)
echo "ğŸ“¦ Checking compilation..."
if ! lamdera make src/Backend.elm src/Frontend.elm tests/Tests.elm; then
    echo "âŒ Compilation failed! Please fix errors before committing."
    exit 1
fi

echo "âœ… Compilation successful!"

# 3. Run tests
echo "ğŸ§ª Running tests..."
if ! elm-test-rs --compiler $(which lamdera); then
    echo "âŒ Tests failed! Please fix failing tests before committing."
    exit 1
fi

echo "âœ… All tests passed!"

# 4. Run elm-review with auto-fix
echo "ğŸ” Running elm-review..."
if ! elm-review --fix-all; then
    echo "âŒ elm-review found issues that couldn't be auto-fixed!"
    echo "   Please run 'elm-review' to see the issues."
    exit 1
fi

echo "âœ… elm-review passed!"
echo "ğŸ‰ Pre-commit checks passed. Proceeding with commit..."

exit 0